<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Account - LuminaWeight</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      background: #f8f9fa;
      font-family: "Segoe UI", sans-serif;
    }
    .navbar-brand {
      font-weight: 700;
      letter-spacing: 0.05em;
    }
    .hero {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      padding: 40px 0;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <!-- Simple navbar â€“ you can copy your existing one here instead -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">LuminaWeight</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html#home">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="all-products.html">All Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="index.html#reviews">Reviews</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="index.html#contact">Contact</a>
          </li>
          <li class="nav-item">
            <button id="logout-btn" class="btn btn-outline-light btn-sm ms-2">
              Logout
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <h1 class="h3 mb-1">My Account</h1>
      <p class="mb-0" id="account-greeting">Loading your detailsâ€¦</p>
    </div>
  </section>

  <!-- Orders -->
  <div class="container mb-5">
    <h2 class="h4 mb-3">Order History</h2>
    <p id="account-status" class="text-muted">Loading ordersâ€¦</p>
    <div id="orders-list"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ðŸ”§ REPLACE with your own Supabase details
    const SUPABASE_URL = "https://YOUR-PROJECT-URL.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-PUBLIC-KEY";

    const supabaseClient = supabase.createClient(
      SUPABASE_URL,
      SUPABASE_ANON_KEY
    );

    const greetingEl = document.getElementById("account-greeting");
    const statusEl = document.getElementById("account-status");
    const ordersEl = document.getElementById("orders-list");
    const logoutBtn = document.getElementById("logout-btn");

    // ðŸ‘¤ Load user + their orders
    async function loadAccount() {
      const {
        data: { user },
        error: userError,
      } = await supabaseClient.auth.getUser();

      if (userError || !user) {
        greetingEl.textContent = "Youâ€™re not logged in.";
        statusEl.innerHTML =
          'Please <a href="index.html" class="link-primary">go back and log in</a> to view your orders.';
        ordersEl.innerHTML = "";
        logoutBtn.style.display = "none";
        return;
      }

      greetingEl.textContent = `Welcome, ${user.email}`;
      statusEl.textContent = "Loading your ordersâ€¦";

      const { data: orders, error } = await supabaseClient
        .from("orders")
        .select("*")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        statusEl.textContent = "Could not load orders.";
        return;
      }

      if (!orders || orders.length === 0) {
        statusEl.textContent = "You donâ€™t have any orders yet.";
        return;
      }

      statusEl.textContent = "";
      const html = orders
        .map((order) => {
          const created = new Date(order.created_at).toLocaleString();
          const total = Number(order.total_amount || 0).toFixed(2);

          // optional: show a summary from details JSON if present
          let summary = "";
          if (order.details && order.details.items) {
            summary =
              order.details.items
                .map(
                  (item) =>
                    `${item.qty} Ã— ${item.name} (${item.dose || ""})`
                )
                .join("<br>") || "";
          }

          return `
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start flex-wrap">
                <div class="me-3">
                  <h5 class="card-title mb-1">Order #${order.id.slice(
                    0,
                    8
                  )}</h5>
                  <small class="text-muted">${created}</small>
                  ${
                    summary
                      ? `<div class="mt-2 small text-muted">${summary}</div>`
                      : ""
                  }
                </div>
                <div class="text-end">
                  <div><strong>Status:</strong> ${order.status || "Pending"}</div>
                  <div><strong>Total:</strong> Â£${total}</div>
                </div>
              </div>
            </div>
          </div>`;
        })
        .join("");

      ordersEl.innerHTML = html;
    }

    // ðŸšª Logout
    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    });

    loadAccount();
  </script>
</body>
</html>