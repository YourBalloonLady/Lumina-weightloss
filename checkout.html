<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Lumina Weight</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{
  --lw-mint:#22c55e;
  --lw-mint-soft:#ecfdf5;
  --lw-blue-soft:#e0f2fe;
  --lw-purple-soft:#eef2ff;
  --lw-dark:#0f172a;
  --lw-muted:#64748b;
  --lw-bg:#f3f4f6;
}
body{
  background:var(--lw-bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
}
.hero{
  background:radial-gradient(circle at top left,var(--lw-mint-soft),#e0f2fe 40%,var(--lw-purple-soft) 100%);
  padding:80px 0 70px;
  text-align:center;
}
.card{
  border-radius:24px;
  border:0;
  box-shadow:0 20px 45px rgba(15,23,42,.1);
}
.form-control{border-radius:12px}
</style>
</head>

<body>

<div class="hero">
  <div class="container">
    <h1 class="fw-bold">Checkout</h1>
    <p class="text-muted">Enter your delivery details below</p>
    <button class="btn btn-outline-secondary btn-sm" onclick="backToShop()">← Back to shop</button>
  </div>
</div>

<div class="container my-5">
  <div class="card">
    <div class="card-body p-5">
      <form id="addressForm">
        <h4 class="fw-semibold mb-4">Delivery Address</h4>

        <div class="row g-3">
          <div class="col-md-6"><input class="form-control" id="fullName" placeholder="Full name" required></div>
          <div class="col-md-6"><input class="form-control" id="phone" placeholder="Phone number" required></div>
          <div class="col-12"><input class="form-control" id="email" type="email" placeholder="Email" required></div>
          <div class="col-12"><input class="form-control" id="address1" placeholder="Address line 1" required></div>
          <div class="col-12"><input class="form-control" id="address2" placeholder="Address line 2"></div>
          <div class="col-md-6"><input class="form-control" id="city" placeholder="City" required></div>
          <div class="col-md-6"><input class="form-control" id="postcode" placeholder="Postcode" required></div>
        </div>

        <hr class="my-4">

        <h4 class="fw-semibold">Order Summary</h4>
        <div id="order-summary"></div>

        <div class="d-flex justify-content-between fw-bold fs-4 mt-3">
          <span>Total</span>
          <span id="final-total">£0.00</span>
        </div>

        <button type="submit" class="btn btn-success btn-lg w-100 rounded-pill mt-4">
          Confirm Order → Payment Details
        </button>

        <div id="checkout-status" class="small mt-2"></div>
      </form>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div class="modal fade" id="paymentModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Order Confirmed</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Thank you <strong id="customerName"></strong></p>
        <p>Your reference: <strong id="order-ref"></strong></p>
        <p>Total: <strong id="payment-total"></strong></p>
        <p class="text-muted">Payment instructions have been emailed.</p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
emailjs.init('uZOuTrBdIAc6AmKjo');

const SUPABASE_URL = "https://qketnqhfjfxbqiuqevnh.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let cart = JSON.parse(localStorage.getItem('cart') || '[]');
let total = cart.reduce((s,i)=>s+(i.price*i.qty),0);

document.getElementById('order-summary').innerHTML =
  cart.map(i=>`<div class="d-flex justify-content-between"><span>${i.qty}× ${i.name}</span><span>£${(i.price*i.qty).toFixed(2)}</span></div>`).join('');

document.getElementById('final-total').textContent = `£${total.toFixed(2)}`;

function buildItemsText(){
  return cart.map(i=>`${i.qty}× ${i.name}`).join('\n');
}
function buildAddressText(d){
  return [d.address1,d.address2,d.city,d.postcode].filter(Boolean).join('\n');
}

// EMAIL FUNCTIONS (RETURN PROMISES)
function sendAdminEmail(d){
  return emailjs.send('service_i5zi096','template_juevvvd',{
    to_email:'luminaweight@gmail.com',
    customer_name:d.name,
    customer_address:buildAddressText(d),
    order_items:buildItemsText(),
    order_reference:d.ref,
    order_total:`£${total.toFixed(2)}`
  });
}
function sendCustomerEmail(d){
  return emailjs.send('service_i5zi096','template_x5lnd1u',{
    to_email:d.email,
    customer_name:d.name,
    order_items:buildItemsText(),
    order_reference:d.ref,
    order_total:`£${total.toFixed(2)}`
  });
}
function sendAbandonedEmail(d,link){
  return emailjs.send('service_i5zi096','template_guh3ord',{
    to_email:d.email,
    customer_name:d.name,
    order_items:buildItemsText(),
    recovery_link:link
  });
}

document.getElementById('addressForm').onsubmit = async e => {
  e.preventDefault();
  const btn = e.target.querySelector('button');
  btn.disabled = true;

  const details = {
    name:fullName.value,
    phone:phone.value,
    email:email.value,
    address1:address1.value,
    address2:address2.value,
    city:city.value,
    postcode:postcode.value,
    ref:'LW'+Date.now().toString().slice(-6)
  };

  const recoveryLink = `https://luminaweight.co.uk/checkout.html?recover=${crypto.randomUUID()}`;

  try{
    const results = await Promise.allSettled([
      sendAdminEmail(details),
      sendCustomerEmail(details),
      sendAbandonedEmail(details,recoveryLink)
    ]);
    console.log('EmailJS results:',results);

    localStorage.removeItem('cart');
    customerName.textContent = details.name;
    order-ref.textContent = details.ref;
    payment-total.textContent = `£${total.toFixed(2)}`;
    new bootstrap.Modal(paymentModal).show();
  }catch(err){
    console.error(err);
    checkout-status.textContent = 'Email error — check console';
  }finally{
    btn.disabled = false;
  }
};

function backToShop(){location.href='index.html'}
</script>
</body>
</html>
